using Content.Client.UserInterface.Controls;
using Content.Shared._FTL.Weapons;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Map;

namespace Content.Client._FTL.Weapons;

[GenerateTypedNameReferences]
public sealed partial class WeaponTargetingWindow : FancyWindow
{
    private WeaponTargetingBoundUserInterface _owner;

    public WeaponTargetingWindow(WeaponTargetingBoundUserInterface owner, EntityUid? mapUid, EntityCoordinates? coordinates, Angle? rotation, EntityUid? trackedEntity = null)
    {
        RobustXamlLoader.Load(this);
        _owner = owner;
        ChangeGrid(mapUid);
        TargetingMapScreen.SetMatrix(coordinates, rotation);

        TargetingMapScreen.OnWeaponMapFire += args =>
        {
            if (TargetingMapScreen.MapUid != null)
                _owner.FireWeapon(args, TargetingMapScreen.MapUid.Value);
        };
        TargetingMapScreen.ScanButton.OnPressed += args =>
        {
            if (TargetingMapScreen.MapUid != null)
                _owner.ScanButton(TargetingMapScreen.MapUid.Value);
        };

        if (trackedEntity != null)
            TargetingMapScreen.TrackedCoordinates.Add(new EntityCoordinates(trackedEntity.Value, Vector2.Zero), (true, Color.Red));

        if (IoCManager.Resolve<IEntityManager>().TryGetComponent<MetaDataComponent>(mapUid, out var metadata))
        {
            Title = metadata.EntityName;
        }
    }

    public void ChangeGrid(EntityUid? gridUid)
    {
        TargetingMapScreen.MapUid = gridUid;
    }

    public void UpdateState(WeaponTargetingUserInterfaceState state)
    {
        TargetingMapScreen.FireButton.Disabled = !state.CanFire;
        TargetingMapScreen.MapUids = state.MapUids;
        if (state.ScanText != null)
        {
            TargetingMapScreen.ScanOutput.Text = state.ScanText;
        }
    }
}
